<script lang="ts">
  import { fade } from 'svelte/transition';
  import LoadingSpinner from './LoadingSpinner.svelte';

  export let visible = false;
  export let top = 0;
  export let left = 0;

  let isLoading = false;

  const handleToolbarButtonClick = async (mode: string) => {
    isLoading = true;
    const selection = window.getSelection();
    const selectionText = selection.toString();
    if (selectionText) {
      console.log(selectionText);
      const response = await chrome.runtime.sendMessage({
        name: 'ai-magic',
        selectionText,
        mode: mode,
      });
      console.log(response);
      if (response.error) {
        // todo: show that an error occurred
        console.error(response.error.message);
      } else if (response.choices?.length > 0) {
        const text = response.choices[0].text;
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(document.createTextNode(text));
        }
      }
    }
    isLoading = false;
  };
</script>

{#key visible}
  <div
    class="toolbar-svelte"
    style="top: {top}px; left: {left}px; display: {visible ? 'flex' : 'none'}"
    transition:fade={{ duration: 200 }}
  >
    {#if !isLoading}
      <div class="button-wrapper">
        <button
          class="btn_summarize"
          title="Summarize"
          on:click={() => handleToolbarButtonClick('summarize')}
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M21 12.75H3C2.59 12.75 2.25 12.41 2.25 12C2.25 11.59 2.59 11.25 3 11.25H21C21.41 11.25 21.75 11.59 21.75 12C21.75 12.41 21.41 12.75 21 12.75Z"
              fill="#292D32"
            />
            <path
              d="M11.9994 22.9084C12.4136 22.9084 12.7494 22.5727 12.7494 22.1584V16.6984L14.2994 18.2484C14.4494 18.3984 14.6394 18.4684 14.8294 18.4684C15.0194 18.4684 15.2094 18.3984 15.3594 18.2484C15.6494 17.9584 15.6494 17.4784 15.3594 17.1884L12.5294 14.3584C12.2494 14.0784 11.7494 14.0784 11.4694 14.3584L8.63938 17.1884C8.34938 17.4784 8.34938 17.9584 8.63938 18.2484C8.92937 18.5384 9.40937 18.5384 9.69937 18.2484L11.2494 16.6984V22.1584C11.2494 22.5727 11.5852 22.9084 11.9994 22.9084V22.9084Z"
              fill="#292D32"
            />
            <path
              d="M12.0006 1.00172C11.5864 1.00172 11.2506 1.33751 11.2506 1.75172L11.2506 7.21172L9.70063 5.66172C9.55063 5.51172 9.36063 5.44172 9.17063 5.44172C8.98063 5.44172 8.79063 5.51172 8.64063 5.66172C8.35063 5.95172 8.35063 6.43172 8.64063 6.72172L11.4706 9.55172C11.7506 9.83172 12.2506 9.83172 12.5306 9.55172L15.3606 6.72172C15.6506 6.43172 15.6506 5.95172 15.3606 5.66172C15.0706 5.37172 14.5906 5.37172 14.3006 5.66172L12.7506 7.21172L12.7506 1.75172C12.7506 1.3375 12.4148 1.00172 12.0006 1.00172V1.00172Z"
              fill="#292D32"
            />
          </svg>
        </button>
        <button
          title="Expand"
          on:click={() => handleToolbarButtonClick('expand')}
          class="btn_expand"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M21 22.75H3C2.59 22.75 2.25 22.41 2.25 22C2.25 21.59 2.59 21.25 3 21.25H21C21.41 21.25 21.75 21.59 21.75 22C21.75 22.41 21.41 22.75 21 22.75Z"
              fill="#292D32"
            />
            <path
              d="M21 2.75H3C2.59 2.75 2.25 2.41 2.25 2C2.25 1.59 2.59 1.25 3 1.25H21C21.41 1.25 21.75 1.59 21.75 2C21.75 2.41 21.41 2.75 21 2.75Z"
              fill="#292D32"
            />
            <path
              d="M14.2994 15.3584L12.7494 16.9084V6.69844L14.2994 8.24844C14.4494 8.39844 14.6394 8.46844 14.8294 8.46844C15.0194 8.46844 15.2094 8.39844 15.3594 8.24844C15.6494 7.95844 15.6494 7.47844 15.3594 7.18844L12.5294 4.35844C12.2494 4.07844 11.7494 4.07844 11.4694 4.35844L8.63938 7.18844C8.34938 7.47844 8.34938 7.95844 8.63938 8.24844C8.92937 8.53844 9.40937 8.53844 9.69937 8.24844L11.2494 6.69844V16.9084L9.69937 15.3584C9.40937 15.0684 8.92937 15.0684 8.63938 15.3584C8.34938 15.6484 8.34938 16.1284 8.63938 16.4184L11.4694 19.2484C11.6094 19.3884 11.7994 19.4684 11.9994 19.4684C12.1994 19.4684 12.3894 19.3884 12.5294 19.2484L15.3594 16.4184C15.6494 16.1284 15.6494 15.6484 15.3594 15.3584C15.0694 15.0684 14.5894 15.0684 14.2994 15.3584Z"
              fill="#292D32"
            />
          </svg>
        </button>
        <button
          class="btn_friendly"
          title="friendly"
          on:click={() => handleToolbarButtonClick('friendly')}
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM8.5 6.38C9.53 6.38 10.38 7.22 10.38 8.26C10.38 9.3 9.54 10.14 8.5 10.14C7.46 10.14 6.62 9.28 6.62 8.25C6.62 7.22 7.47 6.38 8.5 6.38ZM12 19.08C9.31 19.08 7.12 16.89 7.12 14.2C7.12 13.5 7.69 12.92 8.39 12.92H15.59C16.29 12.92 16.86 13.49 16.86 14.2C16.88 16.89 14.69 19.08 12 19.08ZM15.5 10.12C14.47 10.12 13.62 9.28 13.62 8.24C13.62 7.2 14.46 6.36 15.5 6.36C16.54 6.36 17.38 7.2 17.38 8.24C17.38 9.28 16.53 10.12 15.5 10.12Z"
              fill="#292D32"
            />
          </svg>
        </button>
        <button
          class="btn_prompt"
          title="prompt"
          on:click={() => handleToolbarButtonClick('prompt')}
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M19.4998 7.49891L18.0098 8.98891L15.0098 5.98891L16.4998 4.49891C16.9198 4.07891 17.4598 3.87891 17.9998 3.87891C18.5398 3.87891 19.0798 4.07891 19.4998 4.49891C20.3298 5.32891 20.3298 6.66891 19.4998 7.49891Z"
              fill="#292D32"
            />
            <path
              d="M17.3095 9.69922L6.49945 20.4992C5.66945 21.3292 4.32945 21.3292 3.49945 20.4992C2.66945 19.6692 2.66945 18.3292 3.49945 17.4992L14.3095 6.69922L17.3095 9.69922Z"
              fill="#292D32"
            />
            <path
              d="M9.95051 3.50051L10.3605 2.11051C10.4005 1.98051 10.3605 1.84051 10.2705 1.74051C10.1805 1.64051 10.0205 1.60051 9.89051 1.64051L8.50051 2.05051L7.11051 1.64051C6.98051 1.60051 6.84051 1.64051 6.74051 1.73051C6.64051 1.83051 6.61051 1.97051 6.65051 2.10051L7.05051 3.50051L6.64051 4.89051C6.60051 5.0205 6.64051 5.16051 6.73051 5.26051C6.83051 5.36051 6.97051 5.39051 7.10051 5.35051L8.50051 4.95051L9.89051 5.36051C9.93051 5.37051 9.96051 5.38051 10.0005 5.38051C10.1005 5.38051 10.1905 5.34051 10.2705 5.27051C10.3705 5.17051 10.4005 5.03051 10.3605 4.90051L9.95051 3.50051Z"
              fill="#292D32"
            />
            <path
              d="M5.95051 9.50051L6.36051 8.1105C6.40051 7.9805 6.36051 7.84051 6.27051 7.74051C6.17051 7.64051 6.03051 7.61051 5.90051 7.65051L4.50051 8.05051L3.1105 7.64051C2.9805 7.60051 2.84051 7.64051 2.74051 7.73051C2.64051 7.83051 2.61051 7.97051 2.65051 8.10051L3.05051 9.50051L2.64051 10.8905C2.60051 11.0205 2.64051 11.1605 2.73051 11.2605C2.83051 11.3605 2.9705 11.3905 3.1005 11.3505L4.4905 10.9405L5.88051 11.3505C5.91051 11.3605 5.95051 11.3605 5.9905 11.3605C6.0905 11.3605 6.18051 11.3205 6.26051 11.2505C6.36051 11.1505 6.39051 11.0105 6.35051 10.8805L5.95051 9.50051Z"
              fill="#292D32"
            />
            <path
              d="M20.9497 14.5L21.3597 13.11C21.3997 12.98 21.3597 12.84 21.2697 12.74C21.1697 12.64 21.0297 12.61 20.8997 12.65L19.5097 13.06L18.1197 12.65C17.9897 12.61 17.8497 12.65 17.7497 12.74C17.6497 12.84 17.6197 12.98 17.6597 13.11L18.0697 14.5L17.6597 15.89C17.6197 16.02 17.6597 16.16 17.7497 16.26C17.8497 16.36 17.9897 16.39 18.1197 16.35L19.5097 15.94L20.8997 16.35C20.9297 16.36 20.9697 16.36 21.0097 16.36C21.1097 16.36 21.1997 16.32 21.2797 16.25C21.3797 16.15 21.4097 16.01 21.3697 15.88L20.9497 14.5Z"
              fill="#292D32"
            />
          </svg>
        </button>
      </div>
      <div class="divide" />
      <div class="settings-wrapper">
        <button>
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M20.1 9.2214C18.29 9.2214 17.55 7.9414 18.45 6.3714C18.97 5.4614 18.66 4.3014 17.75 3.7814L16.02 2.7914C15.23 2.3214 14.21 2.6014 13.74 3.3914L13.63 3.5814C12.73 5.1514 11.25 5.1514 10.34 3.5814L10.23 3.3914C9.78 2.6014 8.76 2.3214 7.97 2.7914L6.24 3.7814C5.33 4.3014 5.02 5.4714 5.54 6.3814C6.45 7.9414 5.71 9.2214 3.9 9.2214C2.86 9.2214 2 10.0714 2 11.1214V12.8814C2 13.9214 2.85 14.7814 3.9 14.7814C5.71 14.7814 6.45 16.0614 5.54 17.6314C5.02 18.5414 5.33 19.7014 6.24 20.2214L7.97 21.2114C8.76 21.6814 9.78 21.4014 10.25 20.6114L10.36 20.4214C11.26 18.8514 12.74 18.8514 13.65 20.4214L13.76 20.6114C14.23 21.4014 15.25 21.6814 16.04 21.2114L17.77 20.2214C18.68 19.7014 18.99 18.5314 18.47 17.6314C17.56 16.0614 18.3 14.7814 20.11 14.7814C21.15 14.7814 22.01 13.9314 22.01 12.8814V11.1214C22 10.0814 21.15 9.2214 20.1 9.2214ZM12 15.2514C10.21 15.2514 8.75 13.7914 8.75 12.0014C8.75 10.2114 10.21 8.7514 12 8.7514C13.79 8.7514 15.25 10.2114 15.25 12.0014C15.25 13.7914 13.79 15.2514 12 15.2514Z"
              fill="#292D32"
            />
          </svg>
        </button>
        <button
          on:click={() => {
            // reset window selection
            window.getSelection().removeAllRanges();
            visible = false;
          }}
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M12 2C6.49 2 2 6.49 2 12C2 17.51 6.49 22 12 22C17.51 22 22 17.51 22 12C22 6.49 17.51 2 12 2ZM15.36 14.3C15.65 14.59 15.65 15.07 15.36 15.36C15.21 15.51 15.02 15.58 14.83 15.58C14.64 15.58 14.45 15.51 14.3 15.36L12 13.06L9.7 15.36C9.55 15.51 9.36 15.58 9.17 15.58C8.98 15.58 8.79 15.51 8.64 15.36C8.35 15.07 8.35 14.59 8.64 14.3L10.94 12L8.64 9.7C8.35 9.41 8.35 8.93 8.64 8.64C8.93 8.35 9.41 8.35 9.7 8.64L12 10.94L14.3 8.64C14.59 8.35 15.07 8.35 15.36 8.64C15.65 8.93 15.65 9.41 15.36 9.7L13.06 12L15.36 14.3Z"
              fill="#292D32"
            />
          </svg>
        </button>
      </div>
    {:else}
      <div class="lds-wrapper">
        <LoadingSpinner />
      </div>
    {/if}
  </div>
{/key}
